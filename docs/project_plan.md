Below is a **single, stitched-together master plan**.
It folds in every note you gave me:

* **FAISS** (the â€œFacebook AI vector thingâ€) is now the retrieval engine because itâ€™s free + local.
* **Magic MCP** is called out wherever UI or tool instrumentation is involved.
* **LangChain + MCP** are the non-negotiable orchestration layers.
* `docker compose up --build` is the one-liner boot.

Copy-paste the whole thing into your Notion doc or `plan.md` and hand it to Cursorâ€™s agentâ€”no further context required.

---

## 0â€ƒWhy This Exists

| âœ… Must-have                                          | Rationale                                           |
| ---------------------------------------------------- | --------------------------------------------------- |
| **One-command boot** (`docker compose up --build`)   | Judges can clone & run without local setup drama.   |
| **Four â€œlawyerâ€ agents reach a single movie choice** | Demonstrates multi-agent LangChain reasoning + RAG. |
| **Live MCP reasoning stream in the UI**              | Instant â€œwowâ€â€”people see the chain of thought.      |
| **Free vector search** â€“ **FAISS**                   | Zero hosting cost, lightning-fast cosine K-NN.      |

---

## 1â€ƒRepository Layout

```
root/
â”œâ”€ .env.example              # Copy â†’ .env
â”œâ”€ docker-compose.yml
â”œâ”€ README.md

â”œâ”€ backend/
â”‚  â”œâ”€ Dockerfile
â”‚  â”œâ”€ pyproject.toml         # Poetry pins
â”‚  â”œâ”€ app/
â”‚  â”‚  â”œâ”€ main.py             # FastAPI factory + routers
â”‚  â”‚  â”œâ”€ mcp_tools/          # FaissSearchTool, TimerTool, OpenAIChatTool
â”‚  â”‚  â”œâ”€ agents/             # agent_lawyer.py, orchestrator.py
â”‚  â”‚  â”œâ”€ chains/             # profile_chain.py, elimination_chain.py
â”‚  â”‚  â”œâ”€ db/
â”‚  â”‚  â”‚  â”œâ”€ __init__.py      # SQLAlchemy engine
â”‚  â”‚  â”‚  â””â”€ models.py        # Movie model
â”‚  â”‚  â”œâ”€ vector/
â”‚  â”‚  â”‚  â”œâ”€ faiss_index.bin  # Auto-generated
â”‚  â”‚  â”‚  â””â”€ index_meta.json
â”‚  â”‚  â””â”€ utils/              # pairing.py, score.py
â”‚  â””â”€ scripts/
â”‚     â””â”€ build_faiss.py      # One-off index builder
â”‚
â”œâ”€ frontend/
â”‚  â”œâ”€ Dockerfile
â”‚  â”œâ”€ next.config.mjs
â”‚  â”œâ”€ tailwind.config.ts
â”‚  â”œâ”€ pnpm-lock.yaml
â”‚  â””â”€ src/
â”‚     â”œâ”€ pages/index.tsx
â”‚     â”œâ”€ components/
â”‚     â”‚  â”œâ”€ MagicCard.tsx    # generated by 21st.dev
â”‚     â”‚  â”œâ”€ UserModal.tsx
â”‚     â”‚  â”œâ”€ AgentStream.tsx
â”‚     â”‚  â””â”€ ToastProvider.tsx
â”‚     â”œâ”€ hooks/useEventSource.ts
â”‚     â””â”€ lib/api.ts
â”‚
â””â”€ docs/                     # (optional)
```

---

## 2â€ƒData & Embeddings

* **Postgres 16** stores *metadata only*: `id`, `title`, `overview`, `tags TEXT[]`, `embedding REAL[]`.
* **FAISS index** (`vector/faiss_index.bin`) is built by `scripts/build_faiss.py`:

  1. Pulls all movies & embeddings from Postgres.
  2. Builds an **IndexFlatIP** (cosine sim via L2-normalized vectors).
  3. Saves index + `index_meta.json` (rowâ†’movie-id map).
* **Runtime flow**
  `FaissSearchTool` (LangChain wrapper) loads the index at startup; each agentâ€™s query vector returns top-5 movie IDs, then a DB lookup fetches titles.

---

## 3â€ƒFastAPI Surface (MCP-aware)

| Path                      | Verb      | Purpose                                                                     |
| ------------------------- | --------- | --------------------------------------------------------------------------- |
| `/api/start`              | POST      | Body: 4 profile blurbs â†’ launches debate (background task).                 |
| `/api/events/{sessionId}` | GET (SSE) | Streams MCP packets (`agent.thought`, `tool.call`, `round.*`, `consensus`). |
| `/api/status/{sessionId}` | GET       | Snapshot for page refresh / reconnect.                                      |
| `/api/db/embed`           | POST      | Add a movie + embed + FAISS re-index (admin only).                          |

All tool invocations (`openai.chat`, `faiss.search`, etc.) are wrapped by **Magic MCPâ€™s** auto-instrumentation, so they appear in the event stream without extra code.

---

## 4â€ƒAgent Logic (LangChain + MCP)

| Phase                 | Details                                                                                                  | Built-in Safeties                                         |
| --------------------- | -------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| **Profile synthesis** | Each card blurb â†’ `profile_chain` â†’ JSON profile.                                                        | 5 s LLM timeout, 2 retries.                               |
| **Retrieval**         | `FaissSearchTool` â†’ 5 candidate movies / agent.                                                          | One call only.                                            |
| **Debate rounds**     | Round-robin pairs: `[(A,B),(C,D)] â†’ [(A,C),(B,D)] â€¦`. `elimination_chain` drops âŒˆn/2âŒ‰ titles each round. | `max_turns=6`, `max_rounds=5`, `ChainTerminationChecker`. |
| **Consensus**         | Stop when one remains, else pick highest composite happiness.                                            | Emits `CONSENSUS_REACHED`.                                |

---

## 5â€ƒNext.js 15 UI Flow (Magic MCP-heavy)

1. **Layout** â€“ `grid-cols-2 grid-rows-2`, `bg-[#0d0d0d]`.
2. **MagicCard** Ã— 4 â€“ placeholder avatar until profile saved.
3. **UserModal** (shadcn `Dialog`) â€“ collects quick profile form.
4. **Start pill** â€“ bottom-center; enabled after 4 profiles â†’ POST `/api/start`.
5. **AgentStream** â€“ `useEventSource` pipes `agent.thought` lines into a `<CodeBlock>` inside each card (auto-scroll).
6. **Toasts** â€“ round begin/end color-coded; final banner on consensus.
7. **Motion** â€“ `framer-motion` flips modal back into card.

> **Cursor tip:** run **Magic MCP** in-editor to generate Card, Modal, Toast scaffoldsâ€”wire in props, done.

---

## 6â€ƒDocker-Compose

```yaml
version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: movies
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes: [db-data:/var/lib/postgresql/data]
    ports: ["5432:5432"]

  backend:
    build: ./backend
    env_file: .env
    depends_on: [db]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports: ["8000:8000"]

  frontend:
    build: ./frontend
    env_file: .env
    depends_on: [backend]
    command: pnpm start
    ports: ["3000:3000"]

volumes:
  db-data:
```

*No pgvector neededâ€”FAISS lives on disk inside the `backend` container.*

---

## 7â€ƒSecrets (.env.example)

```
OPENAI_API_KEY=sk-...
DATABASE_URL=postgresql://postgres:postgres@db:5432/movies
MCP_HOST=http://backend:8000
NEXT_PUBLIC_MCP_WS=http://localhost:8000/api/events
```

---

## 8â€ƒThree-Hour Stopwatch

| Wall-time   | Deliverable                                                     |
| ----------- | --------------------------------------------------------------- |
| **00â€“30**   | Repo init âœ compose boot âœ FastAPI â€œhelloâ€.                     |
| **30â€“60**   | `/api/start` + skeletal SSE; EventSource + toast proves link.   |
| **60â€“90**   | Magic MCP scaffolds (Card, Modal, Toast). POST form wired.      |
| **90â€“120**  | Build FAISS index + `FaissSearchTool`; confirm 5 picks / agent. |
| **120â€“150** | Debate orchestrator + event streaming (`agent.thought`).        |
| **150â€“165** | UI polish: motion, toasts, consensus banner.                    |
| **165â€“180** | Fresh-clone smoke-test; record 30 sec demo GIF.                 |

---

## 9â€ƒQuality Checklist

1. **`docker compose up --build` works on a blank laptop.**
2. `.env.example` lists every required var.
3. **CORS**: `CORSMiddleware(["*"])` in FastAPI.
4. **Debate loop terminates** (`max_rounds`, `max_turns`).
5. **Frontend reconnects** via `/api/status`.
6. **README**: port map, quick-start, how to rebuild FAISS (`scripts/build_faiss.py`).

---

### Thatâ€™s the whole playbook.

Spin it up, let Magic MCP broadcast every thought, and watch the four movie-lawyers fight to your happiness champion. ğŸ¿
