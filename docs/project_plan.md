Below is a **single, stitched-together master plan**.
It folds in every note you gave me:

* **FAISS** (the “Facebook AI vector thing”) is now the retrieval engine because it’s free + local.
* **Magic MCP** is called out wherever UI or tool instrumentation is involved.
* **LangChain + MCP** are the non-negotiable orchestration layers.
* `docker compose up --build` is the one-liner boot.

Copy-paste the whole thing into your Notion doc or `plan.md` and hand it to Cursor’s agent—no further context required.

---

## 0 Why This Exists

| ✅ Must-have                                          | Rationale                                           |
| ---------------------------------------------------- | --------------------------------------------------- |
| **One-command boot** (`docker compose up --build`)   | Judges can clone & run without local setup drama.   |
| **Four “lawyer” agents reach a single movie choice** | Demonstrates multi-agent LangChain reasoning + RAG. |
| **Live MCP reasoning stream in the UI**              | Instant “wow”—people see the chain of thought.      |
| **Free vector search** – **FAISS**                   | Zero hosting cost, lightning-fast cosine K-NN.      |

---

## 1 Repository Layout

```
root/
├─ .env.example              # Copy → .env
├─ docker-compose.yml
├─ README.md

├─ backend/
│  ├─ Dockerfile
│  ├─ pyproject.toml         # Poetry pins
│  ├─ app/
│  │  ├─ main.py             # FastAPI factory + routers
│  │  ├─ mcp_tools/          # FaissSearchTool, TimerTool, OpenAIChatTool
│  │  ├─ agents/             # agent_lawyer.py, orchestrator.py
│  │  ├─ chains/             # profile_chain.py, elimination_chain.py
│  │  ├─ db/
│  │  │  ├─ __init__.py      # SQLAlchemy engine
│  │  │  └─ models.py        # Movie model
│  │  ├─ vector/
│  │  │  ├─ faiss_index.bin  # Auto-generated
│  │  │  └─ index_meta.json
│  │  └─ utils/              # pairing.py, score.py
│  └─ scripts/
│     └─ build_faiss.py      # One-off index builder
│
├─ frontend/
│  ├─ Dockerfile
│  ├─ next.config.mjs
│  ├─ tailwind.config.ts
│  ├─ pnpm-lock.yaml
│  └─ src/
│     ├─ pages/index.tsx
│     ├─ components/
│     │  ├─ MagicCard.tsx    # generated by 21st.dev
│     │  ├─ UserModal.tsx
│     │  ├─ AgentStream.tsx
│     │  └─ ToastProvider.tsx
│     ├─ hooks/useEventSource.ts
│     └─ lib/api.ts
│
└─ docs/                     # (optional)
```

---

## 2 Data & Embeddings

* **Postgres 16** stores *metadata only*: `id`, `title`, `overview`, `tags TEXT[]`, `embedding REAL[]`.
* **FAISS index** (`vector/faiss_index.bin`) is built by `scripts/build_faiss.py`:

  1. Pulls all movies & embeddings from Postgres.
  2. Builds an **IndexFlatIP** (cosine sim via L2-normalized vectors).
  3. Saves index + `index_meta.json` (row→movie-id map).
* **Runtime flow**
  `FaissSearchTool` (LangChain wrapper) loads the index at startup; each agent’s query vector returns top-5 movie IDs, then a DB lookup fetches titles.

---

## 3 FastAPI Surface (MCP-aware)

| Path                      | Verb      | Purpose                                                                     |
| ------------------------- | --------- | --------------------------------------------------------------------------- |
| `/api/start`              | POST      | Body: 4 profile blurbs → launches debate (background task).                 |
| `/api/events/{sessionId}` | GET (SSE) | Streams MCP packets (`agent.thought`, `tool.call`, `round.*`, `consensus`). |
| `/api/status/{sessionId}` | GET       | Snapshot for page refresh / reconnect.                                      |
| `/api/db/embed`           | POST      | Add a movie + embed + FAISS re-index (admin only).                          |

All tool invocations (`openai.chat`, `faiss.search`, etc.) are wrapped by **Magic MCP’s** auto-instrumentation, so they appear in the event stream without extra code.

---

## 4 Agent Logic (LangChain + MCP)

| Phase                 | Details                                                                                                  | Built-in Safeties                                         |
| --------------------- | -------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| **Profile synthesis** | Each card blurb → `profile_chain` → JSON profile.                                                        | 5 s LLM timeout, 2 retries.                               |
| **Retrieval**         | `FaissSearchTool` → 5 candidate movies / agent.                                                          | One call only.                                            |
| **Debate rounds**     | Round-robin pairs: `[(A,B),(C,D)] → [(A,C),(B,D)] …`. `elimination_chain` drops ⌈n/2⌉ titles each round. | `max_turns=6`, `max_rounds=5`, `ChainTerminationChecker`. |
| **Consensus**         | Stop when one remains, else pick highest composite happiness.                                            | Emits `CONSENSUS_REACHED`.                                |

---

## 5 Next.js 15 UI Flow (Magic MCP-heavy)

1. **Layout** – `grid-cols-2 grid-rows-2`, `bg-[#0d0d0d]`.
2. **MagicCard** × 4 – placeholder avatar until profile saved.
3. **UserModal** (shadcn `Dialog`) – collects quick profile form.
4. **Start pill** – bottom-center; enabled after 4 profiles → POST `/api/start`.
5. **AgentStream** – `useEventSource` pipes `agent.thought` lines into a `<CodeBlock>` inside each card (auto-scroll).
6. **Toasts** – round begin/end color-coded; final banner on consensus.
7. **Motion** – `framer-motion` flips modal back into card.

> **Cursor tip:** run **Magic MCP** in-editor to generate Card, Modal, Toast scaffolds—wire in props, done.

---

## 6 Docker-Compose

```yaml
version: "3.9"

services:
  db:
    image: postgres:16
    environment:
      POSTGRES_DB: movies
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes: [db-data:/var/lib/postgresql/data]
    ports: ["5432:5432"]

  backend:
    build: ./backend
    env_file: .env
    depends_on: [db]
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    ports: ["8000:8000"]

  frontend:
    build: ./frontend
    env_file: .env
    depends_on: [backend]
    command: pnpm start
    ports: ["3000:3000"]

volumes:
  db-data:
```

*No pgvector needed—FAISS lives on disk inside the `backend` container.*

---

## 7 Secrets (.env.example)

```
OPENAI_API_KEY=sk-...
DATABASE_URL=postgresql://postgres:postgres@db:5432/movies
MCP_HOST=http://backend:8000
NEXT_PUBLIC_MCP_WS=http://localhost:8000/api/events
```

---

## 8 Three-Hour Stopwatch

| Wall-time   | Deliverable                                                     |
| ----------- | --------------------------------------------------------------- |
| **00–30**   | Repo init ➜ compose boot ➜ FastAPI “hello”.                     |
| **30–60**   | `/api/start` + skeletal SSE; EventSource + toast proves link.   |
| **60–90**   | Magic MCP scaffolds (Card, Modal, Toast). POST form wired.      |
| **90–120**  | Build FAISS index + `FaissSearchTool`; confirm 5 picks / agent. |
| **120–150** | Debate orchestrator + event streaming (`agent.thought`).        |
| **150–165** | UI polish: motion, toasts, consensus banner.                    |
| **165–180** | Fresh-clone smoke-test; record 30 sec demo GIF.                 |

---

## 9 Quality Checklist

1. **`docker compose up --build` works on a blank laptop.**
2. `.env.example` lists every required var.
3. **CORS**: `CORSMiddleware(["*"])` in FastAPI.
4. **Debate loop terminates** (`max_rounds`, `max_turns`).
5. **Frontend reconnects** via `/api/status`.
6. **README**: port map, quick-start, how to rebuild FAISS (`scripts/build_faiss.py`).

---

### That’s the whole playbook.

Spin it up, let Magic MCP broadcast every thought, and watch the four movie-lawyers fight to your happiness champion. 🍿
